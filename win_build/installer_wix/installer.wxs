<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
    <Product Id="{31209A01-4F85-4476-9A23-A64C75AE94FC}" UpgradeCode="{E913E54D-5080-42EC-A312-B21948BA1C02}" Version="7.22.3.0" Language="1033" 
             Name="BOINC Setup" Manufacturer="Space Sciences Laboratory, U.C. Berkeley">
        <Package InstallerVersion="300" Compressed="yes" InstallPrivileges="elevated" InstallScope="perMachine" AdminImage="yes"/>
        <Media Id="1" Cabinet="boinc.cab" EmbedCab="yes" />
        
        <Property Id="MSIUSEREALADMINDETECTION" Value="1" />     

        <Condition Message="Installation cannot continue on unsupported platforms">
            <![CDATA[((Not Version9X=400) And (Not Version9X=410) And (Not Version9X=490) And (Not VersionNT=400)) And (VersionNT>500)]]>
        </Condition>
        <Condition Message="Installation requires Administrator privileges">
            <![CDATA[Privileged]]>
        </Condition>

        <MajorUpgrade
            DowngradeErrorMessage="A later version of [ProductName] is already installed. Setup will now exit." />

        <Icon Id="installer.ico" SourceFile="$(var.ProjectDir)\installer.ico" />

        <Property Id="ARPPRODUCTICON" Value="installer.ico" />
        <Property Id="WIXUI_INSTALLDIR" Value="TARGETDIR" />
        <Property Id="BOINCBIN" Value="TARGETDIR" />
        <Property Id="BOINCSCREENBIN" Value="TARGETDIR" />
        <Property Id="BOINCDATA" Value="TARGETDIR" />

        <WixVariable Id="WixUILicenseRtf" Value="$(var.ProjectDir)\LICENSE.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="$(var.ProjectDir)\WixUIBannerBmp.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="$(var.ProjectDir)\WixUIDialogBmp.bmp" />

        <SetDirectory Id="BOINCBIN" Value="[ProgramFiles64Folder][ProductName]"/>
        <SetDirectory Id="BOINCSCREENBIN" Value="[WindowsFolder]"/>
        <SetDirectory Id="BOINCDATA" Value="[CommonAppDataFolder][ProductName]"/>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Component Id="TrayStartup" Guid="{ed4c20e8-93ba-4075-ae12-aead0b6a9f93}">
                <RegistryKey Root="HKLM"
                            Key="Software\Microsoft\Windows\CurrentVersion\Run"
                    Action="createAndRemoveOnUninstall">
                    <RegistryValue Type="string" Name="boinctray" Value="[BOINCBIN]\boinctray.exe"/>
                </RegistryKey>
            </Component>
            <Directory Id="DesktopFolder" Name="Desktop">
                <Component Id="SHORTCUT" Guid="{ae10f150-aa1f-427d-8638-d33b2f25c330}">
                    <Shortcut Id="BoincDesktopShortcut"
                        Name="Boinc Manager"
                        Description="Boinc Manager"
                        Target="[BOINCBIN]\boincmgr.exe"
                        Icon="installer.ico"
                        WorkingDirectory="BOINCBIN" />
                    <RemoveFolder Id="BoincDesktopShortcut" On="uninstall"/>
                    <RegistryValue
                        Root="HKCU"
                        Key="Software\Space Sciences Laboratory, U.C. Berkeley\BOINCManager"
                        Name="installed"
                        Type="integer"
                        Value="1"
                        KeyPath="yes"/>
                </Component>
            </Directory>
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="BOINCBIN" />
            </Directory>
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ProgramMenuManufacturer" Name="BOINC" />
            </Directory>
            <Directory Id="WindowsFolder">
                <Directory Id="BOINCSCREENBIN" />
            </Directory>
            <Directory Id="CommonAppDataFolder">
                <Directory Id="BOINCDATA" />
            </Directory>
        </Directory>

        <DirectoryRef Id="ProgramMenuFolder">
            <Component Id="ProgramMenuShortcuts" Guid="{aa958f2e-87dc-4f41-bc6f-f123fa87ef6c}">
                <CreateFolder Directory="ProgramMenuManufacturer"/>
                <RemoveFolder Id="RemoveMenuShortcuts" Directory="ProgramMenuManufacturer" On="uninstall" />

                <RegistryValue Root="HKCU" Key="Software\Space Sciences Laboratory, U.C. Berkeley\BOINCManager" Name="InstalledStartMenuShortcuts" 
                    Type="integer" Value="1" />
            </Component>
        </DirectoryRef>

        <DirectoryRef Id="ProgramMenuManufacturer">
            <Component Id="BoincShortCut" Guid="{9f4a70b9-1877-4e92-b151-d564b7ccebe8}">
                <CreateFolder />
                <RegistryKey Root="HKCU" Key="Software\Space Sciences Laboratory, U.C. Berkeley\BOINCManager" Action="createAndRemoveOnUninstall">
                    <RegistryValue Name="ShortCut" Value="1" Type="integer" KeyPath="yes"/>
                </RegistryKey>

                <!-- Shortcut in Start menu. -->
                <Shortcut Id="ProgramMenuApplicationShortcut" Name="BOINC" Target="[#boincmgr.exe]"
                            Directory="ProgramMenuManufacturer" Show="normal" Icon="installer.ico"/>
            </Component>
        </DirectoryRef>

        <Feature Id="Boinc" Title="Boinc" Level="1" Absent="disallow" AllowAdvertise="no" ConfigurableDirectory="BOINCBIN">
            <ComponentGroupRef Id="BINARYFILES" />
            <ComponentRef Id="TrayStartup" />
            <ComponentRef Id="SHORTCUT" />
            <ComponentRef Id="ProgramMenuShortcuts" />
            <ComponentRef Id="BoincShortCut" />
        </Feature>
        <Feature Id="BoincScreensaver" Title="Boinc Screensaver" Level="32767">
            <ComponentGroupRef Id="SCREENFILES" />
        </Feature>
        <Feature Id="BoincData" Title="Boinc Local Data" Level="1" Absent="disallow" AllowAdvertise="no" ConfigurableDirectory="BOINCDATA">
            <ComponentGroupRef Id="DATAFILES" />
        </Feature>
        
        <UI>
          <UIRef Id="WixUI_FeatureTree" />
        </UI>

        <InstallExecuteSequence>
            <Custom Action="CAAnnounceUpgrade" After="CostFinalize" />
            <!-- <Custom Action="CARestoreSetupState" After="CAAnnounceUpgrade" />
            <Custom Action="CACleanupOldBinaries" After="CAValidateSetupType" />
            <Custom Action="CACreateAcctMgrLoginFile" After="CACreateClientAuthFile" />
            <Custom Action="CACreateBOINCAccounts" After="CAGetUsersGroupName" />
            <Custom Action="CACreateBOINCGroups" After="CACreateBOINCAccounts" />
            <Custom Action="CACreateClientAuthFile" After="CAValidateRebootRequest" />
            <Custom Action="CACreateProjectInitFile" After="CACreateAcctMgrLoginFile" />
            <Custom Action="CADeleteBOINCAccounts" After="CARevokeBOINCProjectRights" />
            <Custom Action="CADeleteBOINCGroups" After="CAGrantBOINCProjectsVirtualBoxRights" />

            <Custom Action="CAGetAdministratorsGroupName" After="InstallInitialize" />
            <Custom Action="CAGetUsersGroupName" After="CAGetAdministratorsGroupName" />
            <Custom Action="CAGrantBOINCAdminsRights" After="CACreateBOINCGroups" />
            <Custom Action="CAGrantBOINCAdminsVirtualBoxRights" After="CARevokeBOINCAdminsRights" />
            <Custom Action="CAGrantBOINCMasterRights" After="CACreateBOINCAccounts" />
            <Custom Action="CAGrantBOINCProjectRights" After="CARevokeBOINCMasterRights" />
            <Custom Action="CAGrantBOINCProjectsRights" After="CARevokeBOINCUsersRights" />
            <Custom Action="CAGrantBOINCProjectsVirtualBoxRights" After="CAGrantBOINCProjectsRights" />
            <Custom Action="CAGrantBOINCUsersRights" After="CAGrantBOINCAdminsVirtualBoxRights" />
            <Custom Action="CARestorePermissionBOINCData" After="CASetPermissionBOINCDataSlots" />

            <Custom Action="CARevokeBOINCAdminsRights" After="CAGrantBOINCAdminsRights" />
            <Custom Action="CARevokeBOINCMasterRights" After="CAGrantBOINCMasterRights" />
            <Custom Action="CARevokeBOINCProjectRights" After="CAGrantBOINCProjectRights" />
            <Custom Action="CARevokeBOINCProjectsRights" After="CAGrantBOINCProjectsRights" />
            <Custom Action="CARevokeBOINCUsersRights" After="CAGrantBOINCUsersRights" />

            <Custom Action="CASaveExecutionState" After="CASaveSetupState" />
            <Custom Action="CASaveSetupState" After="CARestorePermissionBOINCData" />

            <Custom Action="CASetPermissionBOINC" After="CACreateProjectInitFile" />
            <Custom Action="CASetPermissionBOINCData" After="CASetPermissionBOINC" />
            <Custom Action="CASetPermissionBOINCDataProjects" After="CASetPermissionBOINCData" />
            <Custom Action="CASetPermissionBOINCDataSlots" After="CASetPermissionBOINCDataProjects" />

            <Custom Action="CAShutdownBOINC" After="AppSearch" />
            <Custom Action="CAShutdownBOINCManager" After="CAShutdownBOINC" />
            <Custom Action="CAShutdownBOINCScreensaver" After="CAShutdownBOINCManager" />

            <Custom Action="CARestoreExecutionState" After="InstallFinalize" />
            <Custom Action="CAValidateInstall" After="InstallFinalize" />
            <Custom Action="CAValidateRebootRequest" After="CAValidateInstall" />

            <Custom Action="CAValidateSetupType" After="ValidateProductID" /> -->

            <!-- Not in any sequence -->
            <!--
            <Custom Action="CALaunchBOINCManager" After="???" />
            <Custom Action="CALaunchBOINCTray" After="???" />
            <Custom Action="CAVerifyInstallDirectories" After="???" />
            -->
        </InstallExecuteSequence>

    </Product>
</Wix>
